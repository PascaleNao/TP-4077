{"ast":null,"code":"// src/controllers/patientController.js (Fonction getPatientDossier - CORRECTION DÉFINITIVE)\n\n/**\n * Récupère le dossier médical complet d'un patient donné (informations générales et historique des consultations).\n */\nexports.getPatientDossier = async (req, res) => {\n  const patientId = req.userId; // ID du Patient connecté\n\n  try {\n    // 1. Récupérer les informations générales du Dossier Médical\n    const [dossierInfo] = await db.execute(`SELECT \n                allergies, \n                maladies_chroniques, \n                vaccinations, \n                traitements_en_cours \n             FROM DossierMedical \n             WHERE patient_id = ?`, [patientId]);\n\n    // Si le dossier n'existe pas, renvoyer une structure vide mais valide (pour éviter le crash côté client)\n    if (dossierInfo.length === 0) {\n      return res.status(200).json({\n        dossier: {\n          allergies: '',\n          maladies_chroniques: '',\n          vaccinations: '',\n          traitements_en_cours: '',\n          consultations: [] // <-- GARANTIT LA PROPRIÉTÉ CONSULTATIONS\n        }\n      });\n    }\n    const dossierDetails = dossierInfo[0];\n\n    // 2. Récupérer les Consultations associées au Dossier (Historique)\n    // Jointure entre Consultation et DossierMedical sur C.dossier_id = D.patient_id\n    const [consultations] = await db.execute(`SELECT \n                C.consultation_id, \n                C.date_consultation, \n                C.motif, \n                C.notes, \n                C.diagnostic, \n                C.ordonnance_texte, \n                C.created_at\n             FROM Consultation C\n             INNER JOIN DossierMedical D ON C.dossier_id = D.patient_id\n             WHERE D.patient_id = ? \n             ORDER BY C.date_consultation DESC`, [patientId]);\n\n    // 3. ENVELOPPEMENT FINAL : Renvoyer un objet structuré unique.\n    const responseData = {\n      dossier: {\n        ...dossierDetails,\n        consultations: consultations // <-- GARANTIT LA PROPRIÉTÉ CONSULTATIONS, MÊME SI VIDE\n      }\n    };\n    res.json(responseData);\n  } catch (error) {\n    console.error('Erreur serveur critique lors de la récupération du dossier patient:', error);\n    res.status(500).json({\n      message: 'Erreur serveur interne lors de la récupération du dossier.'\n    });\n  }\n};","map":{"version":3,"names":["exports","getPatientDossier","req","res","patientId","userId","dossierInfo","db","execute","length","status","json","dossier","allergies","maladies_chroniques","vaccinations","traitements_en_cours","consultations","dossierDetails","responseData","error","console","message"],"sources":["/home/viviane/TP JIOMEKONG/carnet-frontend/carnet-medical-app/src/components/patient/PatientDossier.jsx"],"sourcesContent":["// src/controllers/patientController.js (Fonction getPatientDossier - CORRECTION DÉFINITIVE)\n\n/**\n * Récupère le dossier médical complet d'un patient donné (informations générales et historique des consultations).\n */\nexports.getPatientDossier = async (req, res) => {\n    const patientId = req.userId; // ID du Patient connecté\n\n    try {\n        // 1. Récupérer les informations générales du Dossier Médical\n        const [dossierInfo] = await db.execute(\n            `SELECT \n                allergies, \n                maladies_chroniques, \n                vaccinations, \n                traitements_en_cours \n             FROM DossierMedical \n             WHERE patient_id = ?`,\n            [patientId]\n        );\n\n        // Si le dossier n'existe pas, renvoyer une structure vide mais valide (pour éviter le crash côté client)\n        if (dossierInfo.length === 0) {\n            return res.status(200).json({\n                dossier: {\n                    allergies: '',\n                    maladies_chroniques: '',\n                    vaccinations: '',\n                    traitements_en_cours: '',\n                    consultations: [] // <-- GARANTIT LA PROPRIÉTÉ CONSULTATIONS\n                }\n            });\n        }\n\n        const dossierDetails = dossierInfo[0];\n\n        // 2. Récupérer les Consultations associées au Dossier (Historique)\n        // Jointure entre Consultation et DossierMedical sur C.dossier_id = D.patient_id\n        const [consultations] = await db.execute(\n            `SELECT \n                C.consultation_id, \n                C.date_consultation, \n                C.motif, \n                C.notes, \n                C.diagnostic, \n                C.ordonnance_texte, \n                C.created_at\n             FROM Consultation C\n             INNER JOIN DossierMedical D ON C.dossier_id = D.patient_id\n             WHERE D.patient_id = ? \n             ORDER BY C.date_consultation DESC`,\n            [patientId]\n        );\n\n        // 3. ENVELOPPEMENT FINAL : Renvoyer un objet structuré unique.\n        const responseData = {\n            dossier: {\n                ...dossierDetails,\n                consultations: consultations // <-- GARANTIT LA PROPRIÉTÉ CONSULTATIONS, MÊME SI VIDE\n            }\n        };\n\n        res.json(responseData);\n\n    } catch (error) {\n        console.error('Erreur serveur critique lors de la récupération du dossier patient:', error);\n        res.status(500).json({ message: 'Erreur serveur interne lors de la récupération du dossier.' });\n    }\n};"],"mappings":"AAAA;;AAEA;AACA;AACA;AACAA,OAAO,CAACC,iBAAiB,GAAG,OAAOC,GAAG,EAAEC,GAAG,KAAK;EAC5C,MAAMC,SAAS,GAAGF,GAAG,CAACG,MAAM,CAAC,CAAC;;EAE9B,IAAI;IACA;IACA,MAAM,CAACC,WAAW,CAAC,GAAG,MAAMC,EAAE,CAACC,OAAO,CAClC;AACZ;AACA;AACA;AACA;AACA;AACA,kCAAkC,EACtB,CAACJ,SAAS,CACd,CAAC;;IAED;IACA,IAAIE,WAAW,CAACG,MAAM,KAAK,CAAC,EAAE;MAC1B,OAAON,GAAG,CAACO,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;QACxBC,OAAO,EAAE;UACLC,SAAS,EAAE,EAAE;UACbC,mBAAmB,EAAE,EAAE;UACvBC,YAAY,EAAE,EAAE;UAChBC,oBAAoB,EAAE,EAAE;UACxBC,aAAa,EAAE,EAAE,CAAC;QACtB;MACJ,CAAC,CAAC;IACN;IAEA,MAAMC,cAAc,GAAGZ,WAAW,CAAC,CAAC,CAAC;;IAErC;IACA;IACA,MAAM,CAACW,aAAa,CAAC,GAAG,MAAMV,EAAE,CAACC,OAAO,CACpC;AACZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+CAA+C,EACnC,CAACJ,SAAS,CACd,CAAC;;IAED;IACA,MAAMe,YAAY,GAAG;MACjBP,OAAO,EAAE;QACL,GAAGM,cAAc;QACjBD,aAAa,EAAEA,aAAa,CAAC;MACjC;IACJ,CAAC;IAEDd,GAAG,CAACQ,IAAI,CAACQ,YAAY,CAAC;EAE1B,CAAC,CAAC,OAAOC,KAAK,EAAE;IACZC,OAAO,CAACD,KAAK,CAAC,qEAAqE,EAAEA,KAAK,CAAC;IAC3FjB,GAAG,CAACO,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MAAEW,OAAO,EAAE;IAA6D,CAAC,CAAC;EACnG;AACJ,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}